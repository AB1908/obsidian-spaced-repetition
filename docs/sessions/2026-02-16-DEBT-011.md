# Session: DEBT-011 — 2026-02-16

## Story
[DEBT-011](../stories/DEBT-011-book-metaphor-clippings.md)

## Goal
Design a navigation model that works for both MoonReader books and markdown clippings. Resolve remaining DEBT-011 acceptance criteria.

## Findings

### Behavior divergence inventory
Identified 5 lifecycle points where MoonReader and markdown sources diverge: import, navigation, deck creation, rendering, mutation confirmation. Only import is handled by the strategy pattern; the other 4 use scattered conditionals in `api.ts`.

### Strategy pattern is underused
`ISourceStrategy` only has `sync()` and `extract()`. `MarkdownSourceStrategy` and `Source` class exist but are dead code — never integrated into `AnnotationsNote`.

### `updateAnnotation()` is broken for paragraphs
Calls `renderAnnotation()` which outputs MoonReader callout format. Paragraphs get transformed via `transform()` to masquerade as annotations, but the rendered markdown is wrong.

### `bookSections` god-array
`(Heading | annotation | paragraph)[]` with duck-typed guards (`highlight !== undefined`, `wasIdPresent !== undefined`). No discriminator field makes pattern matching fragile and error-prone.

### UI components are already generic
Despite book-themed variable names, ChapterList, AnnotationListPage, and annotation-with-outlet components consume abstract data shapes (`{ id, name }[]` for sections, `{ id, title, annotations }` for items). No source-type conditionals in components.

## Decisions

1. **Composition over inheritance** — confirmed ADR-018's choice. Expand strategy interface rather than creating separate source classes.
2. **Discriminated union first** — add `type: 'heading' | 'annotation' | 'paragraph'` before expanding strategies, for cleaner implementation.
3. **4 sequential PRs** — each self-contained, each removes one category of conditionals from api.ts.
4. **Defer renames** — `AnnotationsNote` → `SourceNote`, `bookSections` → `sections`, route paths. Keep PRs focused on structural changes.
5. **Clippings do NOT need their own routes** — components are already generic.

## Artifacts Created
- Plan: `docs/plans/DEBT-011-source-model-seam-repair.md`
- Stories: DEBT-016, DEBT-017, DEBT-018 (meta-workflow improvements identified during analysis)

## Next Steps
- Implement PR 1 (discriminated union)
- Update DEBT-001 status to In Progress when starting
