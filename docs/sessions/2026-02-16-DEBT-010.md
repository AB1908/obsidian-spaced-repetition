# Session: DEBT-010 — 2026-02-16

## Story
[DEBT-010](../stories/DEBT-010-capture-fixture-cycle.md)

## Goal
Wire `captureProxy.ts` into the build system so production Obsidian data can be captured as JSON test fixtures. Immediate target: Atomic Habits book folder.

## Findings
- `captureProxy.ts` existed but was completely unwired (hardcoded `FIXTURES_DIR = 'placeholder'`)
- esbuild `define` option works well for compile-time feature flags
- esbuild CJS output uses getter-only properties for ESM re-exports — `Object.assign` cannot overwrite them (BUG-010)
- `require()` + CJS module cache patching works for runtime interception of disk.ts exports
- Capture proxy captures ALL disk calls during a session, not just the target source

## Decisions
- Use esbuild `define` for `__CAPTURE_MODE__` and `__CAPTURE_FIXTURES_DIR__` (dead-code-eliminated in normal builds)
- Use esbuild plugin to redirect disk imports to captureProxy.ts at build time (not runtime patching — BUG-010, BUG-011 proved runtime approaches impossible due to non-configurable CJS exports)
- captureProxy.ts fulfills its original design: import disk, wrap with Proxy, re-export. No separate capture-disk.ts needed.
- Deleted patchApiForCapture.ts (superseded by captureProxy.ts)
- main.ts unchanged — no runtime wiring needed
- Append mode for fixture filenames (protect existing fixtures; converge to overwrite in future session)
- Record BUG-010, BUG-011, and SPIKE-009 as separate work items

## Bugs Found
- [BUG-010](../stories/BUG-010-capture-proxy-getter-only-exports.md) — Object.assign fails on esbuild getter-only CJS exports
- [BUG-011](../stories/BUG-011-capture-proxy-non-configurable-exports.md) — Object.defineProperty also fails (non-configurable). Fix: esbuild plugin redirects disk imports to captureProxy.ts at build time

## Ideas Spawned
- [SPIKE-009](../stories/SPIKE-009-mcp-devtools-feedback-loop.md) — MCP browser DevTools for self-healing feedback loop

## Next Steps
- User runs `npm run capture` in Obsidian to generate Atomic Habits fixtures
- Rename captured fixtures to semantic names
- Add fixtures to api.test.ts mock + write Atomic Habits test describe block
- Commit fixture data + tests
