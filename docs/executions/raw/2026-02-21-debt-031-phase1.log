Script started on 2026-02-20 20:26:30-08:00 [COMMAND="codex exec --cd .worktrees/refactor-review-session-phase1 --dangerously-bypass-approvals-and-sandbox $'You are delegated to execute one scoped task autonomously in this repository.\n\nExecution contract:\n- Work only on branch: refactor/review-session-phase1\n- Worktree path: .worktrees/refactor-review-session-phase1\n- Follow the scope document exactly: docs/plans/DEBT-031-phase1-review-session-extraction.md\n- Follow the test contract exactly: docs/plans/DEBT-031-phase1-test-contract.md\n- Use strict TDD: make tests fail first, then implement, then verify green.\n- Run required verification commands listed in the scope document.\n- Commit only when acceptance criteria are met.\n- Do not push, do not open PR, do not perform destructive git operations.\n- Final output must include: changed files, tests run, and any deviations from scope.\n\nScope document contents:\n# DEBT-031 Phase 1: Extract ReviewSession\n\n## Context\n\nDEBT-031 plans a 6-phase domain model realignment. Phase 1 (ReviewSession extraction) has **zero overlap** with STORY-016\'s touchpoints and can ship independently without merge conflicts.\n\nSTORY-016 touches: `annotation-categories.ts`, `settings.ts`, `metadataSerializer.ts`, `annotations.ts`, `personal-note.tsx`, `useAnnotationEditor.ts`, `category-filter.tsx`, `annotation-filters.ts`\n\nPhase 1 touches: `AnnotationsNote.ts`, `review-api.ts`, and new `ReviewSession.ts`. No intersection.\n\nReview-related code is already partially factored into helpers (`review-mutations.ts`, `review-deck.ts`, `review-stats.ts`), but the session state (`reviewIndex`, `reviewDeck`) and lifecycle methods (`startReviewing`, `nextReviewCard`, `finishReviewing`, etc.) still live on AnnotationsNote.\n\n---\n\n## What Changes\n\n### New file: `src/data/models/ReviewSession.ts` (~50 lines)\n\nOwns session state machine. Pure — no IO.\n\n```typescript\nimport type { Flashcard } from "src/data/models/flashcard";\nimport { schedulingMetadataForResponse } from "src/data/models/flashcard";\nimport type { ReviewResponse } from "src/types/CardType";\nimport { shuffledReviewDeck } from "./annotations-note/review-deck";\n\nexport interface SchedulingUpdate {\n  flashcardId: string;\n  schedulingMetadata: { interval: number; ease: number; dueDate: string };\n}\n\nexport class ReviewSession {\n  private deck: Flashcard[];\n  private index: number; // -1 = not active\n\n  constructor(flashcards: Flashcard[]) {\n    this.deck = shuffledReviewDeck(flashcards);\n    this.index = -1;\n  }\n\n  start(): void { this.index = 0; }\n  isActive(): boolean { return this.index !== -1; }\n\n  currentCard(): Flashcard | null {\n    if (!this.isActive() || this.index >= this.deck.length) return null;\n    return this.deck[this.index];\n  }\n\n  advance(): void {\n    this.index++;\n    if (this.index >= this.deck.length) this.finish();\n  }\n\n  finish(): void { this.index = -1; }\n\n  canStart(): boolean { return this.deck.length > 0; }\n  get pendingCount(): number { return this.deck.length; }\n\n  /** Pure — returns scheduling intent, caller persists via FlashcardNote */\n  processReview(flashcardId: string, response: ReviewResponse): SchedulingUpdate {\n    const card = this.deck.find(c => c.id === flashcardId);\n    if (!card) throw new Error(`ReviewSession: card ${flashcardId} not found`);\n    return {\n      flashcardId,\n      schedulingMetadata: schedulingMetadataForResponse(response, {\n        interval: card.interval,\n        ease: card.ease,\n        dueDate: card.dueDate,\n      }),\n    };\n  }\n\n  regenerate(flashcards: Flashcard[]): void {\n    this.deck = shuffledReviewDeck(flashcards);\n    this.index = -1;\n  }\n\n  removeCard(flashcardId: string): void {\n    this.deck = this.deck.filter(c => c.id !== flashcardId);\n  }\n}\n```\n\n### Modified: `src/data/models/annotations-note/AnnotationsNote.ts`\n\nReplace `reviewIndex`, `reviewDeck`, and 8 review methods with `review: ReviewSession`.\n\n**Remove fields:** `reviewIndex`, `reviewDeck`\n**Add field:** `review: ReviewSession`\n\n**Remove methods:** `startReviewing`, `isInReview`, `getReviewCard`, `nextReviewCard`, `finishReviewing`, `processCardReview`, `generateReviewDeck`, `resetReview`, `canBeReviewed`\n\n**Keep on AnnotationsNote:** `getReviewStats()` — it combines review state with annotation coverage (coordination concern). Updated to use `this.review.*`.\n\n**Before/after on AnnotationsNote:**\n\n| Before | After |\n|--------|-------|\n| `this.reviewIndex = -1` | `this.review = new ReviewSession(...)` |\n| `this.reviewDeck = []` | (managed inside ReviewSession) |\n| `book.startReviewing()` | `book.review.start()` |\n| `book.isInReview()` | `book.review.isActive()` |\n| `book.getReviewCard()` | `book.review.currentCard()` |\n| `book.nextReviewCard()` | `book.review.advance()` |\n| `book.canBeReviewed()` | `book.review.canStart()` |\n| `book.resetReview()` | `book.review.regenerate(flashcards)` |\n| `book.processCardReview(id, resp)` | Pure: `book.review.processReview(id, resp)` returns `SchedulingUpdate` |\n\n### Modified: `src/application/review-api.ts`\n\nUpdate callers to use `book.review.*`. The key change: `processCardReview` becomes two steps:\n\n```typescript\n// Before (IO hidden inside model)\nawait book.processCardReview(flashcardId, reviewResponse);\n\n// After (caller owns IO)\nconst update = book.review.processReview(flashcardId, reviewResponse);\nawait book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);\n```\n\n### Modified: `src/data/models/annotations-note/initialize-state.ts`\n\nReturns `ReviewSession` instead of `reviewDeck: Flashcard[]`. Caller assigns to `this.review`.\n\n### Remove import: `review-mutations.ts`\n\nNo longer needed — `processFlashcardReview` replaced by `ReviewSession.processReview` (pure) + caller persistence. The file can be deleted.\n\n---\n\n## Files Summary\n\n| File | Action |\n|------|--------|\n| `src/data/models/ReviewSession.ts` | **Create** (~50 lines) |\n| `src/data/models/annotations-note/AnnotationsNote.ts` | **Modify** — replace review state with `review: ReviewSession` |\n| `src/application/review-api.ts` | **Modify** — use `book.review.*`, handle `SchedulingUpdate` |\n| `src/data/models/annotations-note/initialize-state.ts` | **Modify** — return ReviewSession |\n| `src/data/models/annotations-note/review-mutations.ts` | **Delete** (logic moved to ReviewSession.processReview) |\n| `src/data/models/annotations-note/review-deck.ts` | **Keep** (reused by ReviewSession constructor) |\n| `src/data/models/annotations-note/review-stats.ts` | **Keep** (called from getReviewStats) |\n| `tests/api.test.ts` | **Update** — existing review tests should pass with minor import changes |\n| `tests/models/review-session.test.ts` | **Create** — pure unit tests, no mocking needed |\n\n---\n\n## What This Enables\n\n- **Testable review logic** — ReviewSession is a pure state machine, testable without disk mocks\n- **Multi-source decks (future)** — ReviewSession takes `Flashcard[]`, doesn\'t care about source\n- **Clean IO boundary** — `SchedulingUpdate` intent pattern makes persistence explicit\n- **Smaller AnnotationsNote** — removes ~70 lines and 2 fields from the god object\n\n---\n\n## Verification\n\n1. `npm test` — all 38 suites pass (review tests in `api.test.ts` still green)\n2. `npm run build` — compiler passes\n3. New unit tests for ReviewSession cover: start/advance/finish lifecycle, processReview returns correct SchedulingUpdate, regenerate resets state, removeCard during active session\n4. Manual smoke: open plugin, navigate to a source with due cards, review a card, verify scheduling persists\n\n\nTest contract contents:\n# Test Contract: DEBT-031 Phase 1 ReviewSession Extraction\n\n**Story:** `docs/stories/DEBT-031-deterministic-modularization-and-domain-model-evolution.md`\n**Plan:** `docs/plans/DEBT-031-phase1-review-session-extraction.md`\n\n## Required Test Files\nTEST_FILE: tests/api.test.ts\nTEST_FILE: tests/models/review-session.test.ts\n\n## Required Test Names\nTEST_NAME: ReviewSession start/advance/finish lifecycle\nTEST_NAME: ReviewSession processReview returns scheduling update intent\nTEST_NAME: ReviewSession regenerate resets deck and state\nTEST_NAME: ReviewSession removeCard removes cards from active deck\n\n## Required Verification Commands\nTEST_CMD: npm test -- --runInBand tests/models/review-session.test.ts\nTEST_CMD: npm test -- --runInBand tests/api.test.ts\nTEST_CMD: npm test -- --runInBand\nTEST_CMD: OBSIDIAN_PLUGIN_DIR=. npm run build\n\n## Notes\n- This contract is enforced by `scripts/verify-test-contract.sh`.\n- Keep review scheduling persistence in application layer (`review-api.ts`), with pure scheduling intent from `ReviewSession`.' " <not executed on terminal>]
OpenAI Codex v0.104.0 (research preview)
--------
workdir: /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1
model: gpt-5.3-codex
provider: openai
approval: never
sandbox: danger-full-access
reasoning effort: medium
reasoning summaries: auto
session id: 019c7e72-fb86-7de1-8664-f0d3b79f6efd
--------
user
You are delegated to execute one scoped task autonomously in this repository.

Execution contract:
- Work only on branch: refactor/review-session-phase1
- Worktree path: .worktrees/refactor-review-session-phase1
- Follow the scope document exactly: docs/plans/DEBT-031-phase1-review-session-extraction.md
- Follow the test contract exactly: docs/plans/DEBT-031-phase1-test-contract.md
- Use strict TDD: make tests fail first, then implement, then verify green.
- Run required verification commands listed in the scope document.
- Commit only when acceptance criteria are met.
- Do not push, do not open PR, do not perform destructive git operations.
- Final output must include: changed files, tests run, and any deviations from scope.

Scope document contents:
# DEBT-031 Phase 1: Extract ReviewSession

## Context

DEBT-031 plans a 6-phase domain model realignment. Phase 1 (ReviewSession extraction) has **zero overlap** with STORY-016's touchpoints and can ship independently without merge conflicts.

STORY-016 touches: `annotation-categories.ts`, `settings.ts`, `metadataSerializer.ts`, `annotations.ts`, `personal-note.tsx`, `useAnnotationEditor.ts`, `category-filter.tsx`, `annotation-filters.ts`

Phase 1 touches: `AnnotationsNote.ts`, `review-api.ts`, and new `ReviewSession.ts`. No intersection.

Review-related code is already partially factored into helpers (`review-mutations.ts`, `review-deck.ts`, `review-stats.ts`), but the session state (`reviewIndex`, `reviewDeck`) and lifecycle methods (`startReviewing`, `nextReviewCard`, `finishReviewing`, etc.) still live on AnnotationsNote.

---

## What Changes

### New file: `src/data/models/ReviewSession.ts` (~50 lines)

Owns session state machine. Pure — no IO.

```typescript
import type { Flashcard } from "src/data/models/flashcard";
import { schedulingMetadataForResponse } from "src/data/models/flashcard";
import type { ReviewResponse } from "src/types/CardType";
import { shuffledReviewDeck } from "./annotations-note/review-deck";

export interface SchedulingUpdate {
  flashcardId: string;
  schedulingMetadata: { interval: number; ease: number; dueDate: string };
}

export class ReviewSession {
  private deck: Flashcard[];
  private index: number; // -1 = not active

  constructor(flashcards: Flashcard[]) {
    this.deck = shuffledReviewDeck(flashcards);
    this.index = -1;
  }

  start(): void { this.index = 0; }
  isActive(): boolean { return this.index !== -1; }

  currentCard(): Flashcard | null {
    if (!this.isActive() || this.index >= this.deck.length) return null;
    return this.deck[this.index];
  }

  advance(): void {
    this.index++;
    if (this.index >= this.deck.length) this.finish();
  }

  finish(): void { this.index = -1; }

  canStart(): boolean { return this.deck.length > 0; }
  get pendingCount(): number { return this.deck.length; }

  /** Pure — returns scheduling intent, caller persists via FlashcardNote */
  processReview(flashcardId: string, response: ReviewResponse): SchedulingUpdate {
    const card = this.deck.find(c => c.id === flashcardId);
    if (!card) throw new Error(`ReviewSession: card ${flashcardId} not found`);
    return {
      flashcardId,
      schedulingMetadata: schedulingMetadataForResponse(response, {
        interval: card.interval,
        ease: card.ease,
        dueDate: card.dueDate,
      }),
    };
  }

  regenerate(flashcards: Flashcard[]): void {
    this.deck = shuffledReviewDeck(flashcards);
    this.index = -1;
  }

  removeCard(flashcardId: string): void {
    this.deck = this.deck.filter(c => c.id !== flashcardId);
  }
}
```

### Modified: `src/data/models/annotations-note/AnnotationsNote.ts`

Replace `reviewIndex`, `reviewDeck`, and 8 review methods with `review: ReviewSession`.

**Remove fields:** `reviewIndex`, `reviewDeck`
**Add field:** `review: ReviewSession`

**Remove methods:** `startReviewing`, `isInReview`, `getReviewCard`, `nextReviewCard`, `finishReviewing`, `processCardReview`, `generateReviewDeck`, `resetReview`, `canBeReviewed`

**Keep on AnnotationsNote:** `getReviewStats()` — it combines review state with annotation coverage (coordination concern). Updated to use `this.review.*`.

**Before/after on AnnotationsNote:**

| Before | After |
|--------|-------|
| `this.reviewIndex = -1` | `this.review = new ReviewSession(...)` |
| `this.reviewDeck = []` | (managed inside ReviewSession) |
| `book.startReviewing()` | `book.review.start()` |
| `book.isInReview()` | `book.review.isActive()` |
| `book.getReviewCard()` | `book.review.currentCard()` |
| `book.nextReviewCard()` | `book.review.advance()` |
| `book.canBeReviewed()` | `book.review.canStart()` |
| `book.resetReview()` | `book.review.regenerate(flashcards)` |
| `book.processCardReview(id, resp)` | Pure: `book.review.processReview(id, resp)` returns `SchedulingUpdate` |

### Modified: `src/application/review-api.ts`

Update callers to use `book.review.*`. The key change: `processCardReview` becomes two steps:

```typescript
// Before (IO hidden inside model)
await book.processCardReview(flashcardId, reviewResponse);

// After (caller owns IO)
const update = book.review.processReview(flashcardId, reviewResponse);
await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
```

### Modified: `src/data/models/annotations-note/initialize-state.ts`

Returns `ReviewSession` instead of `reviewDeck: Flashcard[]`. Caller assigns to `this.review`.

### Remove import: `review-mutations.ts`

No longer needed — `processFlashcardReview` replaced by `ReviewSession.processReview` (pure) + caller persistence. The file can be deleted.

---

## Files Summary

| File | Action |
|------|--------|
| `src/data/models/ReviewSession.ts` | **Create** (~50 lines) |
| `src/data/models/annotations-note/AnnotationsNote.ts` | **Modify** — replace review state with `review: ReviewSession` |
| `src/application/review-api.ts` | **Modify** — use `book.review.*`, handle `SchedulingUpdate` |
| `src/data/models/annotations-note/initialize-state.ts` | **Modify** — return ReviewSession |
| `src/data/models/annotations-note/review-mutations.ts` | **Delete** (logic moved to ReviewSession.processReview) |
| `src/data/models/annotations-note/review-deck.ts` | **Keep** (reused by ReviewSession constructor) |
| `src/data/models/annotations-note/review-stats.ts` | **Keep** (called from getReviewStats) |
| `tests/api.test.ts` | **Update** — existing review tests should pass with minor import changes |
| `tests/models/review-session.test.ts` | **Create** — pure unit tests, no mocking needed |

---

## What This Enables

- **Testable review logic** — ReviewSession is a pure state machine, testable without disk mocks
- **Multi-source decks (future)** — ReviewSession takes `Flashcard[]`, doesn't care about source
- **Clean IO boundary** — `SchedulingUpdate` intent pattern makes persistence explicit
- **Smaller AnnotationsNote** — removes ~70 lines and 2 fields from the god object

---

## Verification

1. `npm test` — all 38 suites pass (review tests in `api.test.ts` still green)
2. `npm run build` — compiler passes
3. New unit tests for ReviewSession cover: start/advance/finish lifecycle, processReview returns correct SchedulingUpdate, regenerate resets state, removeCard during active session
4. Manual smoke: open plugin, navigate to a source with due cards, review a card, verify scheduling persists


Test contract contents:
# Test Contract: DEBT-031 Phase 1 ReviewSession Extraction

**Story:** `docs/stories/DEBT-031-deterministic-modularization-and-domain-model-evolution.md`
**Plan:** `docs/plans/DEBT-031-phase1-review-session-extraction.md`

## Required Test Files
TEST_FILE: tests/api.test.ts
TEST_FILE: tests/models/review-session.test.ts

## Required Test Names
TEST_NAME: ReviewSession start/advance/finish lifecycle
TEST_NAME: ReviewSession processReview returns scheduling update intent
TEST_NAME: ReviewSession regenerate resets deck and state
TEST_NAME: ReviewSession removeCard removes cards from active deck

## Required Verification Commands
TEST_CMD: npm test -- --runInBand tests/models/review-session.test.ts
TEST_CMD: npm test -- --runInBand tests/api.test.ts
TEST_CMD: npm test -- --runInBand
TEST_CMD: OBSIDIAN_PLUGIN_DIR=. npm run build

## Notes
- This contract is enforced by `scripts/verify-test-contract.sh`.
- Keep review scheduling persistence in application layer (`review-api.ts`), with pure scheduling intent from `ReviewSession`.
mcp startup: no servers

thinking
**Acknowledging task and starting inspection**
codex
I’m executing the scoped Phase 1 extraction exactly per the plan and test contract. First I’ll inspect the current review-related model and tests so I can add failing `ReviewSession` tests before any implementation changes.
exec
/bin/bash -lc "sed -n '1,260p' docs/plans/DEBT-031-phase1-review-session-extraction.md; echo '---'; sed -n '1,260p' docs/plans/DEBT-031-phase1-test-contract.md" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc 'rg --files src/data/models/annotations-note src/application tests | sort' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc 'pwd; git branch --show-current; git status --short' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 50ms:
# DEBT-031 Phase 1: Extract ReviewSession

## Context

DEBT-031 plans a 6-phase domain model realignment. Phase 1 (ReviewSession extraction) has **zero overlap** with STORY-016's touchpoints and can ship independently without merge conflicts.

STORY-016 touches: `annotation-categories.ts`, `settings.ts`, `metadataSerializer.ts`, `annotations.ts`, `personal-note.tsx`, `useAnnotationEditor.ts`, `category-filter.tsx`, `annotation-filters.ts`

Phase 1 touches: `AnnotationsNote.ts`, `review-api.ts`, and new `ReviewSession.ts`. No intersection.

Review-related code is already partially factored into helpers (`review-mutations.ts`, `review-deck.ts`, `review-stats.ts`), but the session state (`reviewIndex`, `reviewDeck`) and lifecycle methods (`startReviewing`, `nextReviewCard`, `finishReviewing`, etc.) still live on AnnotationsNote.

---

## What Changes

### New file: `src/data/models/ReviewSession.ts` (~50 lines)

Owns session state machine. Pure — no IO.

 succeeded in 52ms:
src/application/annotation-api.ts
src/application/deck-api.ts
src/application/deck-creation-helpers.ts
src/application/import-api.ts
src/application/navigation-api.ts
src/application/plugin-context.ts
src/application/review-api.ts
src/application/source-api.ts
src/data/models/annotations-note/AnnotationsNote.ts
src/data/models/annotations-note/AnnotationsNoteIndex.ts
src/data/models/annotations-note/annotation-coverage.ts
src/data/models/annotations-note/annotation-persistence.ts
src/data/models/annotations-note/annotation-transform.ts
src/data/models/annotations-note/constants.ts
src/data/models/annotations-note/drift-detection.ts
src/data/models/annotations-note/flashcard-mutations.ts
src/data/models/annotations-note/frontmatter.ts
src/data/models/annotations-note/initialize-state.ts
src/data/models/annotations-note/processed-annotations.ts
src/data/models/annotations-note/review-deck.ts
 succeeded in 51ms:
/home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1
refactor/review-session-phase1
codex
I confirmed branch/path and loaded both scope + test contract. Next I’m reading the current review implementation and existing API tests to write the new failing unit tests against the target behavior.
exec
/bin/bash -lc "sed -n '1,320p' src/data/models/annotations-note/AnnotationsNote.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
import { nanoid } from "nanoid";
import {
    createFlashcardsFileForBook,
    generateFlashcardsFileNameAndPath,
} from "src/infrastructure/disk";
import type { annotation } from "src/data/models/annotations";
import type { paragraph } from "src/data/models/paragraphs";
import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
import type { ReviewResponse } from "src/types/CardType";
import { CardType } from "src/types/CardType";
import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
import type { BookMetadataSections, Heading } from "../sections/types";
import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
import { updateAnnotationOnDisk } from "./annotation-persistence";
import { computeAnnotationCoverage } from "./annotation-coverage";
import {
    createFlashcardForAnnotation,
    deleteFlashcardById,
exec
/bin/bash -lc "sed -n '1,260p' src/data/models/annotations-note/initialize-state.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "sed -n '1,240p' src/application/review-api.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "sed -n '1,260p' src/data/models/annotations-note/review-mutations.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "sed -n '1,260p' tests/api.test.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 50ms:
import { getFileContents, getMetadataForFile } from "src/infrastructure/disk";
import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
import type { BookMetadataSections } from "../sections/types";
import { bookSections } from "../sections/book-sections";
import { detectDriftedSections } from "./drift-detection";
import { shuffledReviewDeck } from "./review-deck";
import { readBookFrontmatter } from "./frontmatter";
import { resolveSourceDisplayName } from "./source-name";
import { resolveSourceStrategy } from "./source-strategy";
import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";

export interface InitializedSourceState {
    flashcardNote: FlashcardNote | null;
    bookSections: BookMetadataSections;
    name: string;
    tags: string[];
    strategy: FlashcardSourceStrategy;
    reviewDeck: Flashcard[];
}
 succeeded in 51ms:
import { maturityCounts, type Flashcard } from "src/data/models/flashcard";
import { calculateDelayBeforeReview } from "src/data/utils/calculateDelayBeforeReview";
import type { ReviewResponse } from "src/types/CardType";
import type { FrontendFlashcard } from "src/ui/routes/books/review";
import { getPluginContext } from "./plugin-context";

export interface ReviewBook {
    id: string;
    name: string;
    pendingFlashcards: number;
    annotationCoverage: number;
    flashcardProgress: ReturnType<typeof maturityCounts>;
}

export interface FlashCount {
    mature: number;
    new: number;
    learning: number;
}

 succeeded in 51ms:
import { schedulingMetadataForResponse, type FlashcardNote } from "src/data/models/flashcard";
import type { ReviewResponse } from "src/types/CardType";

export async function processFlashcardReview(
    flashcardNote: FlashcardNote,
    flashcardId: string,
    reviewResponse: ReviewResponse
) {
    const card = flashcardNote.flashcards.find(t => t.id === flashcardId);
    if (!card) throw new Error(`processCardReview: card ${flashcardId} not found`);

    const updatedSchedulingMetadata = schedulingMetadataForResponse(reviewResponse, {
        interval: card.interval,
        ease: card.ease,
        dueDate: card.dueDate,
    });
    await flashcardNote.updateCardSchedule(flashcardId, updatedSchedulingMetadata);
}
 succeeded in 51ms:
import { createDiskMockFromFixtures } from "./helpers";
jest.mock("src/infrastructure/disk", () => {
    const mock = createDiskMockFromFixtures([
        "createFlashcardsFileForBook.json",
        "generateFlashcardsFileNameAndPath_2025-12-16T20-02-00_s93m1.json",
        "getAnnotationFilePath_2025-13-12T17-25-00_si3m1.json",
        "getMetadataForFile_2025-12-07T19-37-22-036Z_kzjn5y.json",
        "getFileContents_2025-12-07T19-37-21-944Z_bcx627.json",
        "getFileContents_2025-12-07T19-37-22-044Z_radb6f.json",
        "filePathsWithTag_2025-12-07T19-37-20-520Z_kx3kvy.json",
        "fileTags_2025-12-07T19-37-20-516Z_u0wrbc.json",
        "getTFileForPath_Untitled.json",
        "getTFileForPath_constitution.json",
        "getMetadataForFile_2025-12-07T19-37-20-679Z_gfsis2.json",
        "getMetadataForFile_constitution.json",
        "getFileContents_constitution.json",
        "generateFlashcardsFileNameAndPath_constitution.json",
        "createFlashcardsFileForBook_constitution.json",
        "moveFile_constitution.json",
        "ensureFolder_constitution.json",

thinking
**Preparing to audit removed method usage**
exec
/bin/bash -lc 'rg -n "startReviewing|isInReview|getReviewCard|nextReviewCard|finishReviewing|processCardReview|resetReview|canBeReviewed|reviewDeck|reviewIndex|review-mutations" src tests | sort' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
src/application/review-api.ts:24:    if (!book.isInReview() && book.canBeReviewed()) {
src/application/review-api.ts:25:        book.startReviewing();
src/application/review-api.ts:26:        return book.getReviewCard();
src/application/review-api.ts:27:    } else if (book.isInReview()) {
src/application/review-api.ts:28:        book.nextReviewCard();
src/application/review-api.ts:29:        return book.getReviewCard();
src/application/review-api.ts:42:    if (!book.isInReview() && book.canBeReviewed()) {
src/application/review-api.ts:43:        book.startReviewing();
src/application/review-api.ts:44:        return book.getReviewCard();
src/application/review-api.ts:45:    } else if (book.isInReview()) {
src/application/review-api.ts:46:        return book.getReviewCard();
src/application/review-api.ts:67:    await book.processCardReview(flashcardId, reviewResponse);
src/application/review-api.ts:80:    book.resetReview();
src/application/source-api.ts:21:    canBeReviewed: boolean;
src/application/source-api.ts:42:        canBeReviewed: book.canBeReviewed(),
src/data/models/annotations-note/AnnotationsNote.ts:100:    canBeReviewed() {
src/data/models/annotations-note/AnnotationsNote.ts:101:        return this.reviewDeck.length != 0;
src/data/models/annotations-note/AnnotationsNote.ts:126:    startReviewing() {
src/data/models/annotations-note/AnnotationsNote.ts:127:        this.reviewIndex = 0;
src/data/models/annotations-note/AnnotationsNote.ts:130:    isInReview() {

thinking
**Assessing source-api impact**
codex
I found broad call sites for the old review methods, including `src/application/source-api.ts`, so I’ll keep changes scoped to Phase 1 behavior but update necessary callers to compile against `book.review.*`. I’m now inspecting those dependencies and existing model test patterns before writing the failing ReviewSession tests.
exec
/bin/bash -lc "sed -n '1,260p' src/data/models/annotations-note/review-stats.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "sed -n '1,220p' src/application/source-api.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "sed -n '1,260p' src/data/models/flashcard.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "ls -1 tests/models; sed -n '1,240p' tests/models/annotations-note.module.test.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
import type { Flashcard } from "src/data/models/flashcard";
import { maturityCounts } from "src/data/models/flashcard";

export function computeReviewStats(
    sourceId: string,
    sourceName: string,
    pendingFlashcards: number,
    annotationsWithFlashcardsCount: number,
    annotationsWithoutFlashcardsCount: number,
    flashcards: Flashcard[]
) {
    const progress = maturityCounts(flashcards);
    let annotationCoverage = annotationsWithFlashcardsCount / (annotationsWithFlashcardsCount + annotationsWithoutFlashcardsCount);
    if (isNaN(annotationCoverage)) annotationCoverage = 0;

    return {
        id: sourceId,
        name: sourceName,
        pendingFlashcards,
        annotationCoverage,
 succeeded in 51ms:
import { generateSectionsTree } from "src/data/models/bookTree";
import { maturityCounts } from "src/data/models/flashcard";
import { type SourceType } from "src/data/source-discovery";
import { SourceCapabilities } from "src/data/models/sourceCapabilities";
import { getPluginContext } from "./plugin-context";

export interface frontEndBook {
    counts: {
        annotations: {
            withFlashcards: number;
            withoutFlashcards: number
        };
        flashcards: {
            new: number;
            mature: number;
            learning: number
        }
    };
    name: string;
    id: string;
 succeeded in 51ms:
import { schedule } from "src/scheduler/scheduling";
import { ReviewResponse } from "src/types/CardType";
import { CardType } from "src/types/CardType";
import { nanoid } from "nanoid";
import { FLAG, FlashcardMetadata, parseCardText, parseFileText, parseMetadata } from "src/data/parser";
import { moment, ObsidianNotice } from "src/infrastructure/obsidian-facade";
import {
    cardTextGenerator,
    generateCardAsStorageFormat,
    metadataTextGenerator,
    SchedulingMetadata
} from "src/data/utils/TextGenerator";
import { plugin } from "src/main";
import { createParsedCard, ParsedCard } from "src/data/models/parsedCard";
import { getAnnotationFilePath, updateCardOnDisk, deleteCardOnDisk } from "../../infrastructure/disk";
import { filePathsWithTag } from "src/infrastructure/disk";
import { calculateDelayBeforeReview } from "../utils/calculateDelayBeforeReview";

export interface AbstractFlashcard {
    id: string,
 succeeded in 50ms:
annotations-note-index.module.test.ts
annotations-note.module.test.ts
annotations.test.ts
sections.book-sections.test.ts
sections.guards.test.ts
sections.heading-graph.test.ts
import { AnnotationsNote } from "src/data/models/annotations-note/AnnotationsNote";

describe("annotations-note module", () => {
    test("constructs with path", () => {
        const note = new AnnotationsNote("x.md", {} as never);
        expect(note.path).toBe("x.md");
    });
});

thinking
**Inspecting existing test setup**
exec
/bin/bash -lc "sed -n '1,260p' tests/__mocks__/plugin.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "sed -n '1,260p' tests/setup.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "sed -n '1,260p' tests/__mocks__/src/main.js" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "sed -n '1,240p' jest.config.js; sed -n '1,240p' package.json" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
// tests/__mocks__/plugin.ts

import { AnnotationsNoteDependencies } from "src/data/utils/dependencies";

// This mock is designed to be very lightweight and synchronous for Jest's module mocking.

/**
 * Creates a mock instance of the SRPlugin for testing.
 *
 * @param overrides - An object to override specific properties of the mock plugin.
 *                    This allows you to tailor the mock's behavior for each test.
 *                    For example, you can provide a mock implementation for `annotationsNoteIndex.getBook`.
 */
export function createMockPlugin(overrides?: any): AnnotationsNoteDependencies {
    const defaultMock = {
        // Mock the properties that your API functions actually use
        annotationsNoteIndex: {
            getBook: jest.fn().mockReturnValue(null), // Default to returning null
            getSourcesForReview: jest.fn().mockReturnValue([]),
            getSourcesWithoutFlashcards: jest.fn().mockReturnValue([]),
 succeeded in 52ms:
import 'whatwg-fetch';
import '@testing-library/jest-dom';
// Polyfill for structuredClone for Jest environment
if (typeof global.structuredClone === 'undefined') {
    global.structuredClone = (val) => {
        if (val === undefined) {
            return undefined;
        }
        try {
            return JSON.parse(JSON.stringify(val));
        } catch (e) {
            if (typeof val === 'object' && val !== null) {
                return Array.isArray(val) ? [...val] : { ...val };
            }
            return val;
        }
    };
}

jest.mock("obsidian", () => {
 succeeded in 50ms:
// tests/__mocks__/src/main.js

// This object will be the actual mocked 'plugin' instance.
// Tests can directly modify its properties.
const mockedPluginInstance = {
    app: {},
    fileTagsMap: new Map(),
    data: {
        settings: {
            "baseEase": 250,
            "lapsesIntervalChange": 0.5,
            "easyBonus": 1.3,
            "maximumInterval": 36525,
        },
    },
    annotationsNoteIndex: {
        getBook: jest.fn(),
        initialize: jest.fn(() => Promise.resolve()),
        getSourcesForReview: jest.fn(),
        getSourcesWithoutFlashcards: jest.fn(),
 succeeded in 51ms:
/** @type {import('@ts-jest/dist/types').InitialOptionsTsJest} */
module.exports = {
    preset: "ts-jest",
    testEnvironment: "jsdom",
    setupFilesAfterEnv: ["jest-27-expect-message", "<rootDir>/tests/setup.ts"],
    moduleNameMapper: {
        '^src/(.*)$': '<rootDir>/src/$1'
    },
    collectCoverageFrom: ["src/**/*.ts*"],
    moduleFileExtensions: ["js", "jsx", "ts", "tsx", "json", "node", "d.ts"],
    roots: ["<rootDir>/src/", "<rootDir>/tests/"],
    coveragePathIgnorePatterns: [
        "/node_modules/",
        "src/lang/locale/",
        "src/constants",
        "src/icons",
        "src/declarations.d.ts",
    ],
    coverageDirectory: "coverage",
    maxWorkers: 1,

thinking
**Checking plugin mocking approach**
exec
/bin/bash -lc "rg -n \"jest\\.mock\\(\\\"src/main\\\"|from \\\"src/main\\\"\" tests src | head -n 40" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
src/application/plugin-context.ts:1:import type SRPlugin from "src/main";
src/scheduler/scheduling.ts:1:import { plugin } from "src/main";
src/ui/components/buttons.tsx:5:import { plugin } from "src/main";
src/ui/modals/flashcard-modal.tsx:3:import type SRPlugin from "src/main";
src/api.ts:1:import type SRPlugin from "src/main";
src/settings.ts:4:import type SRPlugin from "src/main";
src/data/models/flashcard.ts:13:import { plugin } from "src/main";

thinking
**Analyzing test mocking behavior**
exec
/bin/bash -lc "sed -n '1,220p' src/main.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
import { Plugin } from "obsidian";
import { FlashcardModal } from "src/ui/modals/flashcard-modal";
import { appIcon } from "src/icons/appicon";
import { t } from "src/lang/helpers";
import { DEFAULT_SETTINGS, SRSettings, SRSettingTab } from "src/settings";
import { FlashcardIndex } from "src/data/models/flashcard";
import { AnnotationsNoteIndex } from "src/data/models/annotations-note/AnnotationsNoteIndex";
import { fileTags } from "src/infrastructure/disk";
import { setPlugin } from "src/api";
import { ObsidianNotice, setApp } from "src/infrastructure/obsidian-facade";
import { Index } from "src/data/models";
import { AnnotationsNoteDependencies } from "src/data/utils/dependencies";

export interface PluginData {
    settings: SRSettings;
    buryDate: string;
    // hashes of card texts
    // should work as long as user doesn't modify card's text
    // which covers most of the cases
    buryList: string[];

thinking
**Evaluating manual mock usage**
exec
/bin/bash -lc "rg -n \"mock\\(['\\\"]src/main['\\\"]\\)\" tests src" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 exited 1 in 50ms:


thinking
**Analyzing plugin mocking impact**
exec
/bin/bash -lc "sed -n '1,260p' src/scheduler/scheduling.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
import { plugin } from "src/main";
import {FrontendFlashcard} from "src/ui/routes/books/review";
import { ReviewResponse } from "../types/CardType";

export function schedule(
    response: ReviewResponse,
    interval: number,
    ease: number,
    delayBeforeReview: number,
): { ease: number; interval: number } {
    delayBeforeReview = Math.max(0, Math.floor(delayBeforeReview / (24 * 3600 * 1000)));
    // todo: remove plugin reference
    const settingsObj = plugin.data.settings;
    if (isNaN(interval)) {
        throw Error("invalid interval");
    }

    if (response === ReviewResponse.Easy) {
        ease += 20;
        interval = ((interval + delayBeforeReview) * ease) / 100;

thinking
**Planning test-first compile failure**
exec
/bin/bash -lc "rg -n \"export interface FlashcardMetadata|type FlashcardMetadata\" src/data/parser.ts; sed -n '1,220p' src/data/parser.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
39:export interface FlashcardMetadata {
import {createParsedCardFromText, ParsedCard} from "src/data/models/parsedCard";
import { CardType } from "src/types/CardType";
import {getFileContents} from "src/infrastructure/disk";

// TODO: parameterize separators??
const CARDTEXT_REGEX = /(?<cardText>.*\n\?\n.*)\n(?<metadataText><!--SR:.*-->)/g;

export async function parseFileText(path: string) {
    const fileText = await getFileContents(path);
    const cardMatchesArray = fileText.matchAll(CARDTEXT_REGEX);
    const parsedCardsArray: ParsedCard[] = [];
    for (const card of cardMatchesArray) {
        if (card.groups === undefined) throw new Error("parseFileText: no text found");
        parsedCardsArray.push(createParsedCardFromText(card.groups.cardText, CardType.MultiLineBasic, path, card.groups.metadataText));
    }
    return parsedCardsArray;
}

export function parseCardText(text: string): [string, string] {

thinking
**Preparing deterministic test setup**
codex
I have enough context. I’m now adding `tests/models/review-session.test.ts` with the four required test names so the first targeted test run fails before implementation, satisfying strict TDD.
exec
/bin/bash -lc "cat > tests/models/review-session.test.ts <<'EOF'
import { FLAG } from \"src/data/parser\";
import { Flashcard } from \"src/data/models/flashcard\";
import { ReviewResponse } from \"src/types/CardType\";
import { ReviewSession } from \"src/data/models/ReviewSession\";

function dueFlashcard(id: string, dueDate = \"2025-12-01\") {
    return new Flashcard(
        "'`parsed-${id}`,
        `Q-${id}`,
        `A-${id}`,
        {
            annotationId: `ann-${id}`,
            dueDate,
            interval: 4,
            ease: 250,
            flag: FLAG.LEARNING,
        }
    );
}

describe("ReviewSession", () => {
    test("ReviewSession start/advance/finish lifecycle", () => {
        const session = new ReviewSession([dueFlashcard("1"), dueFlashcard("2")]);

        expect(session.isActive()).toBe(false);
        expect(session.currentCard()).toBeNull();
        expect(session.canStart()).toBe(true);

        session.start();
        const first = session.currentCard();
        expect(first).not.toBeNull();

        session.advance();
        const second = session.currentCard();
        expect(second).not.toBeNull();
        expect(second?.id).not.toBe(first?.id);

        session.advance();
        expect(session.isActive()).toBe(false);
        expect(session.currentCard()).toBeNull();

        session.start();
        session.finish();
        expect(session.isActive()).toBe(false);
    });

    test("ReviewSession processReview returns scheduling update intent", () => {
        const card = dueFlashcard("1", "2025-12-20");
        const session = new ReviewSession([card]);

        const update = session.processReview(card.id, ReviewResponse.Easy);

        expect(update.flashcardId).toBe(card.id);
        expect(update.schedulingMetadata).toEqual({
            dueDate: "2025-12-28",
            ease: 270,
            interval: 14,
        });
    });

    test("ReviewSession regenerate resets deck and state", () => {
        const session = new ReviewSession([dueFlashcard("1")]);

        session.start();
        expect(session.isActive()).toBe(true);

        session.regenerate([dueFlashcard("2")]);

        expect(session.isActive()).toBe(false);
        expect(session.pendingCount).toBe(1);
        expect(session.currentCard()).toBeNull();

        session.start();
        expect(session.currentCard()?.id).toBe("2");
    });

    test("ReviewSession removeCard removes cards from active deck", () => {
        const first = dueFlashcard("1");
        const second = dueFlashcard("2");
        const session = new ReviewSession([first, second]);

        session.start();
        session.removeCard(first.id);

        expect(session.pendingCount).toBe(1);
        expect(session.currentCard()?.id).toBe(second.id);
    });
});
EOF' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:


thinking
**Running initial failure test**
exec
/bin/bash -lc 'npm test -- --runInBand tests/models/review-session.test.ts' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 exited 1 in 1.92s:
FAIL tests/models/review-session.test.ts
  ● Test suite failed to run

    Configuration error:

    Could not locate module src/data/models/ReviewSession mapped as:
    /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/src/$1.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^src\/(.*)$/": "/home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/src/$1"
      },
      "resolver": undefined
    }

      2 | import { Flashcard } from "src/data/models/flashcard";
      3 | import { ReviewResponse } from "src/types/CardType";
    > 4 | import { ReviewSession } from "src/data/models/ReviewSession";
        | ^
codex
Fail-first is confirmed (`ReviewSession` module missing).  
I’m moving to implementation in this order:

1. Create `src/data/models/ReviewSession.ts` with the pure state machine and scheduling intent return type.
2. Refactor `AnnotationsNote` to own a `review: ReviewSession` field, remove the old review state/methods, and route review stats/reset/delete behavior through `review`.
3. Refactor initialization to return `review: ReviewSession` from `initialize-state.ts`.
4. Update application APIs to call `book.review.*` and keep scheduling persistence in `review-api.ts`.
5. Remove `src/data/models/annotations-note/review-mutations.ts` and clean imports/usages.
6. Update `tests/api.test.ts` only if needed for compatibility.
7. Run required verification commands exactly in contract order and confirm green, then commit.

thinking
**Inspecting review-related methods**
exec
/bin/bash -lc "sed -n '1,280p' src/data/models/annotations-note/AnnotationsNoteIndex.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
import { selectEligibleSourcePaths } from "src/data/source-discovery";
import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
import { AnnotationsNote } from "./AnnotationsNote";

export class AnnotationsNoteIndex {
    sourceNotes: AnnotationsNote[];

    constructor() {
        this.sourceNotes = [];
    }

    async initialize(plugin: AnnotationsNoteDependencies) {
        const candidatePaths = selectEligibleSourcePaths(plugin.fileTagsMap);
        const notesWithAnnotations = candidatePaths.map((t: string) => new AnnotationsNote(t, plugin));
        for (const t of notesWithAnnotations) {
            try {
                await t.initialize();
            } catch (e) {
                // WARNING! this is dangerous, I am catching other errors and just assuming that
                // these are this error

thinking
**Adjusting flashcard deletion flow**
exec
/bin/bash -lc "sed -n '1,220p' src/data/models/annotations-note/flashcard-mutations.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
import { addBlockIdToParagraph } from "src/data/models/paragraphs";
import { isParagraph } from "../sections/guards";
import type { BookMetadataSections } from "../sections/types";
import { updateCardOnDisk } from "src/infrastructure/disk";
import { CardType } from "src/types/CardType";

export async function createFlashcardForAnnotation(
    sourcePath: string,
    bookSections: BookMetadataSections,
    flashcardNote: FlashcardNote,
    annotationId: string,
    question: string,
    answer: string,
    cardType: CardType.MultiLineBasic
) {
    const block = bookSections.filter(t => t.id === annotationId)[0];
    if (isParagraph(block) && !block.wasIdPresent) {
        const text = addBlockIdToParagraph(block);
        await updateCardOnDisk(sourcePath, block.text, text);

thinking
**Evaluating helper signature change**
exec
/bin/bash -lc "rg -n \"deleteFlashcardById\\(\" src tests" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
src/data/models/annotations-note/AnnotationsNote.ts:177:        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
src/data/models/annotations-note/flashcard-mutations.ts:26:export async function deleteFlashcardById(

thinking
**Inspecting re-export of path**
exec
/bin/bash -lc "sed -n '1,220p' src/data/models/AnnotationsNote.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
import { Heading, type BookMetadataSections, type Count } from "./sections/types";

export { ANNOTATIONS_YAML_KEY } from "./annotations-note/constants";
export type { BookFrontmatter, book, frontbook } from "./annotations-note/types";

export type { RawBookSection, BookMetadataSection, BookMetadataSections, Count } from "./sections/types";
export { Heading } from "./sections/types";
export { isAnnotation, isAnnotationOrParagraph, isChapter, isHeading, isParagraph } from "./sections/guards";
export {
    findNextHeader,
    findPreviousHeaderForHeading,
    findPreviousHeaderForSection,
    generateHeaderCounts,
    updateHeaders,
} from "./sections/heading-graph";
export { bookSections } from "./sections/book-sections";
export { AnnotationsNote } from "./annotations-note/AnnotationsNote";
export { AnnotationsNoteIndex } from "./annotations-note/AnnotationsNoteIndex";

thinking
**Planning multi-file patch approach**
exec
/bin/bash -lc "cat > src/data/models/ReviewSession.ts <<'EOF'
import type { Flashcard } from \"src/data/models/flashcard\";
import { schedulingMetadataForResponse } from \"src/data/models/flashcard\";
import type { ReviewResponse } from \"src/types/CardType\";
import { shuffledReviewDeck } from \"./annotations-note/review-deck\";

export interface SchedulingUpdate {
    flashcardId: string;
    schedulingMetadata: { interval: number; ease: number; dueDate: string };
}

export class ReviewSession {
    private deck: Flashcard[];
    private index: number;

    constructor(flashcards: Flashcard[]) {
        this.deck = shuffledReviewDeck(flashcards);
        this.index = -1;
    }

    start(): void {
        this.index = 0;
    }

    isActive(): boolean {
        return this.index "'!== -1;
    }

    currentCard(): Flashcard | null {
        if (!this.isActive() || this.index >= this.deck.length) return null;
        return this.deck[this.index];
    }

    advance(): void {
        this.index++;
        if (this.index >= this.deck.length) this.finish();
    }

    finish(): void {
        this.index = -1;
    }

    canStart(): boolean {
        return this.deck.length > 0;
    }

    get pendingCount(): number {
        return this.deck.length;
    }

    processReview(flashcardId: string, response: ReviewResponse): SchedulingUpdate {
        const card = this.deck.find(t => t.id === flashcardId);
        if (!card) throw new Error(`ReviewSession: card ${flashcardId} not found`);

        return {
            flashcardId,
            schedulingMetadata: schedulingMetadataForResponse(response, {
                interval: card.interval,
                ease: card.ease,
                dueDate: card.dueDate,
            }),
        };
    }

    regenerate(flashcards: Flashcard[]): void {
        this.deck = shuffledReviewDeck(flashcards);
        this.index = -1;
    }

    removeCard(flashcardId: string): void {
        this.deck = this.deck.filter(t => t.id !== flashcardId);
    }
}
EOF' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:

codex
I’ve created `ReviewSession.ts` and am now wiring it through initialization and `AnnotationsNote`, removing old review fields/methods and replacing callers with `review` state machine usage.

thinking
**Applying initialization patch**
file update
M /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/src/data/models/annotations-note/initialize-state.ts
@@ -6,3 +6,2 @@
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
@@ -10,3 +9,4 @@
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
@@ -18,3 +18,3 @@
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
@@ -47,3 +47,3 @@
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
@@ -55,3 +55,3 @@
         strategy,
-        reviewDeck,
+        review,
     };
apply_patch(auto_approved=true) exited 0 in 4ms:
Success. Updated the following files:
M src/data/models/annotations-note/initialize-state.ts
file update:
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }

file update:
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Cleaning up patch imports**
file update
M /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/src/data/models/annotations-note/AnnotationsNote.ts
@@ -8,3 +8,2 @@
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
@@ -13,2 +12,3 @@
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
@@ -24,4 +24,2 @@
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
@@ -39,5 +37,4 @@
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
@@ -51,4 +48,3 @@
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
@@ -72,3 +68,3 @@
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
@@ -97,6 +93,2 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
@@ -123,42 +115,4 @@
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
@@ -176,8 +130,4 @@
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
@@ -185,3 +135,3 @@
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
@@ -190,3 +140,3 @@
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
apply_patch(auto_approved=true) exited 0 in 6ms:
Success. Updated the following files:
M src/data/models/annotations-note/AnnotationsNote.ts
file update:
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }

file update:
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Checking and updating flashcard imports**
file update
M /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,2 +1,2 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
@@ -27,3 +27,2 @@
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
@@ -31,3 +30,2 @@
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
apply_patch(auto_approved=true) exited 0 in 8ms:
Success. Updated the following files:
M src/data/models/annotations-note/flashcard-mutations.ts
file update:
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }

file update:
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }

file update
M /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/src/application/review-api.ts
@@ -23,8 +23,8 @@
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
@@ -41,7 +41,7 @@
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
@@ -66,3 +66,4 @@
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
@@ -79,3 +80,3 @@
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
apply_patch(auto_approved=true) exited 0 in 2ms:
Success. Updated the following files:
M src/application/review-api.ts
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }

file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Replacing source-api method**
codex
I finished the core refactor and now I’m updating remaining callers (`source-api` and any direct references) to `book.review.canStart()` so the codebase compiles without the removed model methods.
file update
M /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/src/application/source-api.ts
@@ -41,3 +41,3 @@
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
apply_patch(auto_approved=true) exited 0 in 10ms:
Success. Updated the following files:
M src/application/source-api.ts
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }

file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Removing obsolete file**
exec
/bin/bash -lc 'rm src/data/models/annotations-note/review-mutations.ts' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:

file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Checking export and import references**
exec
/bin/bash -lc "rg -n \"review-mutations|canBeReviewed\\(|startReviewing\\(|isInReview\\(|getReviewCard\\(|nextReviewCard\\(|finishReviewing\\(|processCardReview\\(|resetReview\\(|reviewDeck|reviewIndex\" src tests | sort" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
src/data/models/annotations-note/review-deck.ts:10:    return reviewDeck;
src/data/models/annotations-note/review-deck.ts:5:    const reviewDeck = [...flashcards].filter(t => t.isDue());
src/data/models/annotations-note/review-deck.ts:6:    for (let i = reviewDeck.length - 1; i > 0; i--) {
src/data/models/annotations-note/review-deck.ts:8:        [reviewDeck[i], reviewDeck[j]] = [reviewDeck[j], reviewDeck[i]];
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Inspecting imports for cleanup**
exec
/bin/bash -lc "sed -n '1,320p' src/data/models/annotations-note/AnnotationsNote.ts" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
import { nanoid } from "nanoid";
import {
    createFlashcardsFileForBook,
    generateFlashcardsFileNameAndPath,
} from "src/infrastructure/disk";
import type { annotation } from "src/data/models/annotations";
import type { paragraph } from "src/data/models/paragraphs";
import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
import { CardType } from "src/types/CardType";
import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
import { ReviewSession } from "../ReviewSession";
import type { BookMetadataSections, Heading } from "../sections/types";
import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
import { updateAnnotationOnDisk } from "./annotation-persistence";
import { computeAnnotationCoverage } from "./annotation-coverage";
import {
    createFlashcardForAnnotation,
    deleteFlashcardById,
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..50113f40817cc39cb15df1b598ee81409428c416
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -6,11 +6,11 @@
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
 import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
 import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -95,10 +91,6 @@
 
     private resolveStrategy(): FlashcardSourceStrategy {
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
-    }
-
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
     }
 
     annotations() {
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
-    }
-
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
     }
 
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Removing unused imports**
file update
M /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/src/data/models/annotations-note/AnnotationsNote.ts
@@ -7,3 +7,3 @@
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
@@ -14,3 +14,3 @@
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
apply_patch(auto_approved=true) exited 0 in 12ms:
Success. Updated the following files:
M src/data/models/annotations-note/AnnotationsNote.ts
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }

file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Running tests for review mutations**
exec
/bin/bash -lc 'npm test -- --runInBand tests/models/review-session.test.ts' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 exited 1 in 1.68s:
FAIL tests/models/review-session.test.ts
  ● ReviewSession › ReviewSession regenerate resets deck and state

    expect(received).toBe(expected) // Object.is equality

    Expected: "2"
    Received: "ETos-kDW"

      72 |
      73 |         session.start();
    > 74 |         expect(session.currentCard()?.id).toBe("2");
         |                                           ^
      75 |     });
      76 |
      77 |     test("ReviewSession removeCard removes cards from active deck", () => {

      at Object.<anonymous> (tests/models/review-session.test.ts:74:43)
      at TestScheduler.scheduleTests (../../node_modules/@jest/core/build/TestScheduler.js:333:13)
      at runJest (../../node_modules/@jest/core/build/runJest.js:404:19)
      at _run10000 (../../node_modules/@jest/core/build/cli/index.js:320:7)
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }


thinking
**Assigning explicit card IDs**
codex
The new unit test suite is running and surfaced one deterministic-id issue in the test itself. I’m fixing the test helper to assign stable flashcard ids, then re-running the required commands.
file update
M /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1/tests/models/review-session.test.ts
@@ -6,3 +6,3 @@
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
@@ -18,2 +18,4 @@
     );
+    card.id = id;
+    return card;
 }
apply_patch(auto_approved=true) exited 0 in 15ms:
Success. Updated the following files:
M tests/models/review-session.test.ts
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {

file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {

exec
/bin/bash -lc 'npm test -- --runInBand tests/models/review-session.test.ts' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 1.60s:
PASS tests/models/review-session.test.ts

Test Suites: 1 passed, 1 total
Tests:       4 passed, 4 total
Snapshots:   0 total
Time:        1.069 s
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {

exec
/bin/bash -lc 'npm test -- --runInBand tests/api.test.ts' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 2.56s:
PASS tests/api.test.ts

Test Suites: 1 passed, 1 total
Tests:       4 skipped, 40 passed, 44 total
Snapshots:   19 passed, 19 total
Time:        2.053 s
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {


thinking
**Running full test suite**
codex
The targeted test contract commands for `review-session` and `api` are green. I’m now running the full in-band test suite and then the required build command.
exec
/bin/bash -lc 'npm test -- --runInBand' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 6.71s:
PASS tests/routes/import/PersonalNotePage.test.tsx
PASS tests/disk.test.ts
PASS tests/routes/import/ImportDashboard.test.tsx
PASS tests/book.test.ts
PASS tests/annotations.test.ts
PASS tests/parser.test.ts
PASS tests/deck-landing-page.test.tsx
PASS tests/routes/books/book/annotation/AnnotationListPage.test.tsx
PASS tests/paragraphs.test.ts
PASS tests/api.clippings.test.ts
PASS tests/annotationGenerator.test.ts
PASS tests/components/PreviewExistingFlashcards.test.tsx
PASS tests/scheduling.test.ts
PASS tests/lang/helpers.test.ts
PASS tests/routes_books_api.test.ts
PASS tests/annotation_with_outlet.test.tsx
PASS tests/api_orchestrator.test.ts
PASS tests/bug008.source-naming.test.ts
PASS tests/components/ChapterList.test.tsx
PASS tests/personal-note-page.test.tsx
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {


thinking
**Starting command implementation**
exec
/bin/bash -lc 'OBSIDIAN_PLUGIN_DIR=. npm run build' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 233ms:

  main.js  1.9mb ⚠️

⚡ Done in 115ms
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {


thinking
**Running contract verification script**
exec
/bin/bash -lc 'scripts/verify-test-contract.sh docs/plans/DEBT-031-phase1-test-contract.md' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
[contract] file: docs/plans/DEBT-031-phase1-test-contract.md
[contract] repo-root: .
[contract][OK] test file exists: tests/api.test.ts
[contract][OK] test file exists: tests/models/review-session.test.ts
[contract][OK] test name found: ReviewSession start/advance/finish lifecycle
[contract][OK] test name found: ReviewSession processReview returns scheduling update intent
[contract][OK] test name found: ReviewSession regenerate resets deck and state
[contract][OK] test name found: ReviewSession removeCard removes cards from active deck
[contract][SKIP] required command not executed: npm test -- --runInBand tests/models/review-session.test.ts
[contract][SKIP] required command not executed: npm test -- --runInBand tests/api.test.ts
[contract][SKIP] required command not executed: npm test -- --runInBand
[contract][SKIP] required command not executed: OBSIDIAN_PLUGIN_DIR=. npm run build
[contract] verification passed
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {


thinking
**Noticing shell non-persistence affecting logs**
codex
All required verification commands are passing locally after the refactor. I’ll do a final diff audit against scope, then commit on `refactor/review-session-phase1` and report changed files/tests/deviations.
exec
/bin/bash -lc 'git status --short' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc "git diff -- src/data/models/ReviewSession.ts src/data/models/annotations-note/AnnotationsNote.ts src/application/review-api.ts src/data/models/annotations-note/initialize-state.ts src/data/models/annotations-note/review-mutations.ts src/data/models/annotations-note/flashcard-mutations.ts src/application/source-api.ts tests/models/review-session.test.ts tests/api.test.ts | sed -n '1,320p'" in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1exec
/bin/bash -lc 'git add src/data/models/ReviewSession.ts src/data/models/annotations-note/AnnotationsNote.ts src/application/review-api.ts src/data/models/annotations-note/initialize-state.ts src/data/models/annotations-note/review-mutations.ts src/data/models/annotations-note/flashcard-mutations.ts src/application/source-api.ts tests/models/review-session.test.ts && git commit -m "refactor: extract ReviewSession from AnnotationsNote"' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
 M src/application/review-api.ts
 M src/application/source-api.ts
 M src/data/models/annotations-note/AnnotationsNote.ts
 M src/data/models/annotations-note/flashcard-mutations.ts
 M src/data/models/annotations-note/initialize-state.ts
 D src/data/models/annotations-note/review-mutations.ts
?? main.js
?? src/data/models/ReviewSession.ts
?? tests/models/review-session.test.ts
 succeeded in 52ms:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b..55acdd7 100644
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@ export interface FlashCount {
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
 succeeded in 51ms:
[refactor/review-session-phase1 dd06b68] refactor: extract ReviewSession from AnnotationsNote
 8 files changed, 193 insertions(+), 100 deletions(-)
 create mode 100644 src/data/models/ReviewSession.ts
 delete mode 100644 src/data/models/annotations-note/review-mutations.ts
 create mode 100644 tests/models/review-session.test.ts
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {


thinking
**Checking uncommitted changes**
exec
/bin/bash -lc 'git status --short' in /home/abhishek/github/obsidian-spaced-repetition/.worktrees/refactor-review-session-phase1 succeeded in 51ms:
?? main.js
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {


thinking
**Summarizing final status and deviations**
codex
Implemented on branch `refactor/review-session-phase1` with strict TDD (fail first, then implement, then green), committed as `dd06b68`.

**Changed files**
- `src/data/models/ReviewSession.ts` (new)
- `src/data/models/annotations-note/AnnotationsNote.ts`
- `src/application/review-api.ts`
- `src/data/models/annotations-note/initialize-state.ts`
- `src/data/models/annotations-note/review-mutations.ts` (deleted)
- `tests/models/review-session.test.ts` (new)
- `src/data/models/annotations-note/flashcard-mutations.ts`
- `src/application/source-api.ts`

**TDD evidence**
- Fail-first run before implementation:
  - `npm test -- --runInBand tests/models/review-session.test.ts`
  - Failed with missing module `src/data/models/ReviewSession`
- After implementation: all required test-contract commands passed.

**Tests run**
1. `npm test -- --runInBand tests/models/review-session.test.ts` ✅
2. `npm test -- --runInBand tests/api.test.ts` ✅
3. `npm test -- --runInBand` ✅ (39 suites passed)
4. `OBSIDIAN_PLUGIN_DIR=. npm run build` ✅

**Deviations from scope**
- Added two necessary compatibility edits not explicitly listed in file summary:
  - `src/application/source-api.ts` updated to use `book.review.canStart()`
  - `src/data/models/annotations-note/flashcard-mutations.ts` simplified `deleteFlashcardById` signature since review deck is now encapsulated in `ReviewSession`
- Manual smoke verification from scope (“open plugin, review a card, verify persistence”) was not run in this headless environment.
file update:
diff --git a/src/application/review-api.ts b/src/application/review-api.ts
index fcd907b70feb3de2364848291b53106e916b4403..55acdd7812709db8eb8bb6cc19a9fd7601c9472a
--- a/src/application/review-api.ts
+++ b/src/application/review-api.ts
@@ -21,12 +21,12 @@
 export function getNextCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        book.nextReviewCard();
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        book.review.advance();
+        return book.review.currentCard();
     }
 }
 
@@ -39,11 +39,11 @@
 export function getCurrentCard(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    if (!book.isInReview() && book.canBeReviewed()) {
-        book.startReviewing();
-        return book.getReviewCard();
-    } else if (book.isInReview()) {
-        return book.getReviewCard();
+    if (!book.review.isActive() && book.review.canStart()) {
+        book.review.start();
+        return book.review.currentCard();
+    } else if (book.review.isActive()) {
+        return book.review.currentCard();
     }
 }
 
@@ -64,7 +64,8 @@
 ) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    await book.processCardReview(flashcardId, reviewResponse);
+    const update = book.review.processReview(flashcardId, reviewResponse);
+    await book.flashcardNote.updateCardSchedule(update.flashcardId, update.schedulingMetadata);
     return true;
 }
 
@@ -77,5 +78,5 @@
 export function resetBookReviewState(bookId: string) {
     const plugin = getPluginContext();
     const book = plugin.annotationsNoteIndex.getBook(bookId);
-    book.resetReview();
+    book.review.regenerate(book.flashcardNote?.flashcards || []);
 }
diff --git a/src/application/source-api.ts b/src/application/source-api.ts
index 26b485756f7c479e862936ffb0a6e4ecf4ca5522..e46473aeb61548b4338601175f9751878ed0e672
--- a/src/application/source-api.ts
+++ b/src/application/source-api.ts
@@ -39,7 +39,7 @@
     return {
         id: book.id,
         name: book.name,
-        canBeReviewed: book.canBeReviewed(),
+        canBeReviewed: book.review.canStart(),
         counts: {
             flashcards: maturityCounts(book.flashcardNote.flashcards || []),
             annotations: {
diff --git a/src/data/models/annotations-note/AnnotationsNote.ts b/src/data/models/annotations-note/AnnotationsNote.ts
index 6d52b4ca2b97a673c24f9e8d4639088a4f6bf1e2..59e10510fe5677c99a2216c071dc0a189967ecad
--- a/src/data/models/annotations-note/AnnotationsNote.ts
+++ b/src/data/models/annotations-note/AnnotationsNote.ts
@@ -5,14 +5,14 @@
 } from "src/infrastructure/disk";
 import type { annotation } from "src/data/models/annotations";
 import type { paragraph } from "src/data/models/paragraphs";
-import { Flashcard, FlashcardNote } from "src/data/models/flashcard";
-import type { ReviewResponse } from "src/types/CardType";
+import { FlashcardNote } from "src/data/models/flashcard";
 import { CardType } from "src/types/CardType";
 import type { AnnotationsNoteDependencies } from "src/data/utils/dependencies";
 import type { FlashcardSourceStrategy } from "../FlashcardSourceStrategy";
 import { getSourceCapabilities as buildSourceCapabilities, type SourceCapabilities } from "../sourceCapabilities";
+import { ReviewSession } from "../ReviewSession";
 import type { BookMetadataSections, Heading } from "../sections/types";
-import { isAnnotationOrParagraph, isParagraph } from "../sections/guards";
+import { isAnnotationOrParagraph } from "../sections/guards";
 import { updateAnnotationOnDisk } from "./annotation-persistence";
 import { computeAnnotationCoverage } from "./annotation-coverage";
 import {
@@ -22,8 +22,6 @@
 } from "./flashcard-mutations";
 import { getProcessedAnnotationsForSection } from "./processed-annotations";
 import { initializeSourceState } from "./initialize-state";
-import { processFlashcardReview } from "./review-mutations";
-import { shuffledReviewDeck } from "./review-deck";
 import { computeReviewStats } from "./review-stats";
 import { toAnnotationLike } from "./annotation-transform";
 import { readBookFrontmatter } from "./frontmatter";
@@ -37,9 +35,8 @@
     bookSections: BookMetadataSections;
     id: string;
     name: string;
-    reviewIndex: number;
     tags: string[];
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
     flashcardNote: FlashcardNote | null;
     strategy: FlashcardSourceStrategy;
     plugin: AnnotationsNoteDependencies;
@@ -49,8 +46,7 @@
         this.name = "";
         this.path = path;
         this.bookSections = [];
-        this.reviewIndex = -1;
-        this.reviewDeck = [];
+        this.review = new ReviewSession([]);
         this.plugin = plugin;
         this.flashcardNote = null;
         this.tags = [];
@@ -70,7 +66,7 @@
         this.name = state.name;
         this.tags = state.tags;
         this.strategy = state.strategy;
-        this.reviewDeck = state.reviewDeck;
+        this.review = state.review;
         return this;
     }
 
@@ -97,10 +93,6 @@
         return resolveSourceStrategy(this.path, this.tags, !!this.getBookFrontmatter());
     }
 
-    canBeReviewed() {
-        return this.reviewDeck.length != 0;
-    }
-
     annotations() {
         return this.bookSections.filter((t): t is (annotation | paragraph) => isAnnotationOrParagraph(t));
     }
@@ -121,46 +113,8 @@
         const match = this.annotations().find(t => t.id === annotationId);
         if (!match) throw new Error(`Annotation not found: ${annotationId}`);
         return toAnnotationLike(match);
-    }
-
-    startReviewing() {
-        this.reviewIndex = 0;
-    }
-
-    isInReview() {
-        return this.reviewIndex != -1;
-    }
-
-    getReviewCard(): Flashcard | null {
-        if (!this.isInReview()) {
-            new Error("Book is not in review");
-        }
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            return null;
-        }
-        return this.reviewDeck[this.reviewIndex];
-    }
-
-    nextReviewCard() {
-        this.reviewIndex++;
-        if (this.reviewIndex >= this.reviewDeck.length) {
-            this.finishReviewing();
-        }
     }
 
-    finishReviewing() {
-        this.reviewIndex = -1;
-        this.generateReviewDeck();
-    }
-
-    async processCardReview(flashcardId: string, reviewResponse: ReviewResponse) {
-        await processFlashcardReview(this.flashcardNote!, flashcardId, reviewResponse);
-    }
-
-    private generateReviewDeck() {
-        this.reviewDeck = shuffledReviewDeck(this.flashcardNote?.flashcards || []);
-    }
-
     async createFlashcard(annotationId: string, question: string, answer: string, cardType: CardType.MultiLineBasic) {
         await createFlashcardForAnnotation(
             this.path,
@@ -174,21 +128,17 @@
     }
 
     async deleteFlashcard(id: string) {
-        this.reviewDeck = await deleteFlashcardById(this.flashcardNote!, this.reviewDeck, id);
-    }
-
-    resetReview() {
-        this.generateReviewDeck();
-        this.reviewIndex = -1;
+        await deleteFlashcardById(this.flashcardNote!, id);
+        this.review.removeCard(id);
     }
 
     getReviewStats() {
-        this.resetReview();
+        this.review.regenerate(this.flashcardNote?.flashcards || []);
         const { annotationsWithFlashcards, annotationsWithoutFlashcards } = this.annotationCoverage();
         return computeReviewStats(
             this.id,
             this.name,
-            this.reviewDeck.length,
+            this.review.pendingCount,
             annotationsWithFlashcards.size,
             annotationsWithoutFlashcards.size,
             this.flashcardNote?.flashcards || []
diff --git a/src/data/models/annotations-note/flashcard-mutations.ts b/src/data/models/annotations-note/flashcard-mutations.ts
index 0f1f224106a5e5da68fb05195556e8bf8cddddcd..c1041296d31169bba9533f2a5b42767515020aff
--- a/src/data/models/annotations-note/flashcard-mutations.ts
+++ b/src/data/models/annotations-note/flashcard-mutations.ts
@@ -1,4 +1,4 @@
-import { type Flashcard, type FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
 import { addBlockIdToParagraph } from "src/data/models/paragraphs";
 import { isParagraph } from "../sections/guards";
 import type { BookMetadataSections } from "../sections/types";
@@ -25,11 +25,9 @@
 
 export async function deleteFlashcardById(
     flashcardNote: FlashcardNote,
-    reviewDeck: Flashcard[],
     flashcardId: string
 ) {
     await flashcardNote.deleteCard(flashcardId);
-    return reviewDeck.filter(t => t.id !== flashcardId);
 }
 
 export async function updateFlashcardContentsByType(
diff --git a/src/data/models/annotations-note/initialize-state.ts b/src/data/models/annotations-note/initialize-state.ts
index ccd4dc7f1c3675e9c27e0c7ac42ad0fbf8d0a35a..44649312f8482c828c09cb09bb227ddbbf70f035
--- a/src/data/models/annotations-note/initialize-state.ts
+++ b/src/data/models/annotations-note/initialize-state.ts
@@ -4,11 +4,11 @@
 import type { BookMetadataSections } from "../sections/types";
 import { bookSections } from "../sections/book-sections";
 import { detectDriftedSections } from "./drift-detection";
-import { shuffledReviewDeck } from "./review-deck";
 import { readBookFrontmatter } from "./frontmatter";
 import { resolveSourceDisplayName } from "./source-name";
 import { resolveSourceStrategy } from "./source-strategy";
-import type { Flashcard, FlashcardNote } from "src/data/models/flashcard";
+import type { FlashcardNote } from "src/data/models/flashcard";
+import { ReviewSession } from "../ReviewSession";
 
 export interface InitializedSourceState {
     flashcardNote: FlashcardNote | null;
@@ -16,7 +16,7 @@
     name: string;
     tags: string[];
     strategy: FlashcardSourceStrategy;
-    reviewDeck: Flashcard[];
+    review: ReviewSession;
 }
 
 export async function initializeSourceState(
@@ -45,7 +45,7 @@
 
     const tags = plugin.fileTagsMap.get(sourcePath) as string[];
     const strategy = resolveSourceStrategy(sourcePath, tags, !!readBookFrontmatter(sourcePath, sourceId));
-    const reviewDeck = shuffledReviewDeck(flashcardNote?.flashcards || []);
+    const review = new ReviewSession(flashcardNote?.flashcards || []);
 
     return {
         flashcardNote,
@@ -53,6 +53,6 @@
         name,
         tags,
         strategy,
-        reviewDeck,
+        review,
     };
 }
diff --git a/tests/models/review-session.test.ts b/tests/models/review-session.test.ts
index 38468eda6c9e0f325e5d5896562bf00c9bb18995..6e66f0f74f82ec81e50d2d84744955003d7657da
--- a/tests/models/review-session.test.ts
+++ b/tests/models/review-session.test.ts
@@ -4,7 +4,7 @@
 import { ReviewSession } from "src/data/models/ReviewSession";
 
 function dueFlashcard(id: string, dueDate = "2025-12-01") {
-    return new Flashcard(
+    const card = new Flashcard(
         `parsed-${id}`,
         `Q-${id}`,
         `A-${id}`,
@@ -16,6 +16,8 @@
             flag: FLAG.LEARNING,
         }
     );
+    card.id = id;
+    return card;
 }
 
 describe("ReviewSession", () => {

tokens used
79,260
Implemented on branch `refactor/review-session-phase1` with strict TDD (fail first, then implement, then green), committed as `dd06b68`.

**Changed files**
- `src/data/models/ReviewSession.ts` (new)
- `src/data/models/annotations-note/AnnotationsNote.ts`
- `src/application/review-api.ts`
- `src/data/models/annotations-note/initialize-state.ts`
- `src/data/models/annotations-note/review-mutations.ts` (deleted)
- `tests/models/review-session.test.ts` (new)
- `src/data/models/annotations-note/flashcard-mutations.ts`
- `src/application/source-api.ts`

**TDD evidence**
- Fail-first run before implementation:
  - `npm test -- --runInBand tests/models/review-session.test.ts`
  - Failed with missing module `src/data/models/ReviewSession`
- After implementation: all required test-contract commands passed.

**Tests run**
1. `npm test -- --runInBand tests/models/review-session.test.ts` ✅
2. `npm test -- --runInBand tests/api.test.ts` ✅
3. `npm test -- --runInBand` ✅ (39 suites passed)
4. `OBSIDIAN_PLUGIN_DIR=. npm run build` ✅

**Deviations from scope**
- Added two necessary compatibility edits not explicitly listed in file summary:
  - `src/application/source-api.ts` updated to use `book.review.canStart()`
  - `src/data/models/annotations-note/flashcard-mutations.ts` simplified `deleteFlashcardById` signature since review deck is now encapsulated in `ReviewSession`
- Manual smoke verification from scope (“open plugin, review a card, verify persistence”) was not run in this headless environment.

Script done on 2026-02-20 20:30:14-08:00 [COMMAND_EXIT_CODE="0"]
