# Session Note: BUG-006 Refactor-First Plan

## Date
2026-02-16

## Story
- [BUG-006](../stories/BUG-006-source-chooser-label-uses-folder-name.md)

## Why this note exists
We identified a critical sequencing mistake in the earlier fix attempt: we changed infrastructure semantics first, when the safer boundary-preserving approach is to keep infrastructure stable and move domain logic out of `src/api.ts` into the model layer.

This note captures a refactor-first plan before any further implementation.

## Problem Restatement
Current chooser label behavior is affected by `book.name`, but name-setting logic is spread across:
- `AnnotationsNote.initialize()` (model)
- `createFlashcardNoteForAnnotationsNote()` in `src/api.ts` (orchestration)

The API layer currently performs source-mutation and name-setting behavior that should live in the domain model. This coupling causes larger blast radius when fixing display semantics.

## Refactor-First Scope (No behavior broadening)

### Goal
Move domain-specific source mutation + display-name updates into `AnnotationsNote` (or source-specific strategy owned by model), leaving `api.ts` as orchestration only.

### Non-goals
- No new source types introduced in this pass.
- No broad redesign of section/chapter navigation in this pass.
- No infrastructure API removals unless proven unused after model refactor.

## Proposed Implementation Plan

### Phase 1 — Extract domain operations from `api.ts`
1. Introduce a model-owned operation on `AnnotationsNote` that performs the direct-markdown prep currently in API:
   - add block IDs to paragraphs
   - ensure source is in own folder
   - refresh internal `path` and `name`
2. Keep orchestration contract in API minimal:
   - API validates preconditions/user confirmation
   - API invokes single model method
   - API updates indexes only where orchestration is genuinely required

**Expected result:** `api.ts` stops manually setting `book.name` and stops owning markdown mutation details.

### Phase 2 — Define name semantics in model
1. Add a model-level helper (or strategy callback) for display name policy.
2. For BUG-006, enforce chooser primary name = source filename/title semantics for direct-markdown sources.
3. Keep secondary location context (folder/path) in DTO/UI layer only.

**Expected result:** label policy is explicit and testable in model, not inferred from disk helper behavior.

### Phase 3 — Infrastructure decoupling cleanup
1. Re-evaluate `disk.ts` helpers after callsite consolidation.
2. Remove or replace domain-leaking helper usage only after model owns policy.
3. Keep infra methods narrowly focused on Obsidian filesystem metadata access.

**Expected result:** smaller infra change surface; less regression risk.

## Test Plan (targeted)
- Model tests for name-setting before/after folderization in direct-markdown flow.
- API tests to verify orchestration calls model operation instead of mutating name/path directly.
- Regression for nested vs root source label behavior in deck creation chooser.
- Confirm MoonReader path remains unchanged.

## Risks and Mitigations
- **Risk:** breaking index consistency after source move.
  - **Mitigation:** add assertions around index/fileTagsMap updates in tests.
- **Risk:** duplicated mutation logic during transition.
  - **Mitigation:** temporary wrappers with clear TODO-to-remove and same-session cleanup.
- **Risk:** hidden coupling in route loaders expecting old side-effects.
  - **Mitigation:** run targeted route/import tests plus clippings flow tests.

## Definition of Done for next implementation PR
- `api.ts` no longer owns direct-markdown mutation/name policy.
- BUG-006 acceptance criteria satisfied with minimal API diff.
- Test coverage includes explicit regression for folder != filename.
- Session note updated with plan-vs-actual reconciliation.

## Workflow Meta Observations
1. **Plan mode first is mandatory for bug work.**
   - Before coding: write scope, touched files, invariants, and test intent.
2. **Use a human-reviewed plan checkpoint.**
   - For `BUG-*` branches, require a reviewed plan artifact committed before implementation commits.
3. **Reduce plan drift with post-task reconciliation.**
   - Add a short “planned vs actual” section at close-out: what changed, why, and whether scope expanded.
4. **Codex Web default behavior needs explicit scaffolding.**
   - Provide a reusable prompt template requiring: constraints, scope boundary, phased plan, and rollback strategy.
5. **Optional process improvement:** split planning/review into separate thread or agent lane.
   - Planning lane produces reviewed plan commit.
   - Implementation lane references plan commit hash and reports deltas.

## Suggested Prompt Contract for future BUG sessions
- Step 1: “Plan-only mode. No edits.”
- Step 2: Produce phased file-level scope + risk matrix.
- Step 3: Commit reviewed plan note under `docs/session/YYYY-MM-DD-bug-XXX.md`.
- Step 4: Only then execute implementation.
- Step 5: Reconcile implementation with plan in final session update.

## Reconciliation Update (implementation follow-up)

### Planned vs Actual
- **Planned:** keep infrastructure stable and move direct-markdown mutation behavior out of `api.ts`.
- **Actual:** implemented model-owned `prepareDirectMarkdownSourceForDeckCreation()` in `AnnotationsNote` and replaced API inline mutation logic with a single method call.
- **Planned:** minimize API diff.
- **Actual:** removed API-local mutation helpers and related disk imports; API now validates confirmation and delegates mutation to model.
- **Planned:** avoid infrastructure-first semantic change.
- **Actual:** restored `getParentOrFilename` in infrastructure and reverted test fixture naming to `getParentOrFilename_*`.

### Outcome
This aligns BUG-006 with the intended boundary: API orchestrates, model owns source mutation/name policy, infrastructure remains a stable facade.

## Atomic Commit Discipline (follow-up)
- We should keep changes split into logical units and avoid mixed commits that bundle docs + refactor + test-infra hardening.
- For BUG-006 specifically, the "actual bug fix" belongs in the code/refactor commit (`src/api.ts`, `src/data/models/AnnotationsNote.ts`, and behavior-regression tests).
- Test infrastructure hardening (`tests/helpers.ts`) should be a separate commit, because it changes fixture/mocking behavior beyond BUG-006 logic.
- Session/docs updates should be their own commit.
- Working rule: any new change in this branch should be committed immediately in the smallest coherent unit.
