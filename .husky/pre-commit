#!/bin/sh

# Check 1: Ensure .worktrees/ is in .gitignore (always enforced)
if ! grep -q '^\.worktrees/$' .gitignore; then
  echo 'Error: Your .gitignore is missing the ".worktrees/" entry.' >&2
  echo 'Please add ".worktrees/" to your .gitignore file to prevent committing worktree data.' >&2
  exit 1
fi

# Check 2: Branch-aware commit approval
BRANCH=$(git branch --show-current)
APPROVAL_FILE=".commit-approval"

if [ "$BRANCH" = "main" ]; then
  # HARD ENFORCEMENT on main branch
  echo "→ Committing to main branch (hard enforcement)" >&2

  if [ ! -f "$APPROVAL_FILE" ]; then
    echo "" >&2
    echo "❌ ERROR: No commit approval found (main branch)" >&2
    echo "" >&2
    echo "Main branch requires explicit approval before committing." >&2
    echo "" >&2
    echo "Workflow:" >&2
    echo "  1. Claude drafts commit message (1-2 lines)" >&2
    echo "  2. Claude shows you message + files" >&2
    echo "  3. You approve or request changes" >&2
    echo "  4. Claude creates .commit-approval file" >&2
    echo "  5. Claude commits (this hook validates)" >&2
    echo "" >&2
    echo "See CLAUDE.md for complete workflow documentation." >&2
    echo "" >&2
    echo "To bypass (emergencies only): git commit --no-verify" >&2
    exit 1
  fi

  # Check if approval file is fresh (< 5 minutes old)
  if [ "$(uname)" = "Darwin" ]; then
    FILE_TIME=$(stat -f %m "$APPROVAL_FILE")
  else
    FILE_TIME=$(stat -c %Y "$APPROVAL_FILE")
  fi

  CURRENT_TIME=$(date +%s)
  AGE=$((CURRENT_TIME - FILE_TIME))

  if [ $AGE -gt 300 ]; then
    echo "" >&2
    echo "❌ ERROR: Approval file is stale (main branch)" >&2
    echo "" >&2
    echo "The .commit-approval file is $AGE seconds old (limit: 300s)." >&2
    echo "Please re-approve the commit with Claude." >&2
    exit 1
  fi

  echo "✓ Commit approved for main branch"

else
  # SOFT ENFORCEMENT on feature branches
  echo "→ Committing to feature branch '$BRANCH' (soft enforcement)" >&2

  if [ ! -f "$APPROVAL_FILE" ]; then
    echo "" >&2
    echo "⚠️  WARNING: No approval file (allowed on feature branches)" >&2
    echo "" >&2
    echo "Consider following the approval workflow for cleaner commits:" >&2
    echo "  • Keep messages concise (1-2 lines)" >&2
    echo "  • Use conventional commits format" >&2
    echo "  • Details go in documentation, not commit messages" >&2
    echo "" >&2
    echo "Proceeding with commit..." >&2
  else
    echo "✓ Commit approved (feature branch)"
  fi
fi

# Check 3: Run tests (all branches)
echo "→ Running tests..." >&2
if ! npm test --silent 2>&1; then
  echo "" >&2
  echo "❌ ERROR: Tests failed. Fix failing tests before committing." >&2
  echo "To bypass (emergencies only): git commit --no-verify" >&2
  exit 1
fi
echo "✓ All tests passed"
