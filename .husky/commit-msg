#!/bin/sh

COMMIT_MSG_FILE="$1"
BRANCH=$(git branch --show-current)

# Extract message (excluding comments and empty lines)
MESSAGE=$(grep -v '^#' "$COMMIT_MSG_FILE" | grep -v '^$')
LINE_COUNT=$(echo "$MESSAGE" | wc -l)

# Get subject line (first non-comment line)
SUBJECT_LINE=$(echo "$MESSAGE" | head -n1)
SUBJECT_LENGTH=${#SUBJECT_LINE}

# Check conventional commit format (optional, just for info)
CONVENTIONAL_PATTERN='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'
if ! echo "$SUBJECT_LINE" | grep -Eq "$CONVENTIONAL_PATTERN"; then
  NEEDS_FORMAT_FIX=true
else
  NEEDS_FORMAT_FIX=false
fi

if [ "$BRANCH" = "main" ]; then
  # HARD ENFORCEMENT on main branch
  echo "‚Üí Validating commit message (main branch - hard enforcement)" >&2

  if [ "$LINE_COUNT" -gt 5 ]; then
    echo "" >&2
    echo "‚ùå ERROR: Commit message too long ($LINE_COUNT lines) on main branch" >&2
    echo "" >&2
    echo "Commits should be 1-2 lines. Details go in documentation." >&2
    echo "Philosophy: 'Commits tell WHAT. Documentation tells WHY.'" >&2
    echo "" >&2
    echo "Your message:" >&2
    echo "$MESSAGE" | head -5 >&2
    [ "$LINE_COUNT" -gt 5 ] && echo "..." >&2
    echo "" >&2
    echo "See docs/git_workflow.md for guidelines." >&2
    echo "To bypass: git commit --no-verify" >&2
    exit 1
  fi

  if [ "$SUBJECT_LENGTH" -gt 72 ]; then
    echo "" >&2
    echo "‚ö†Ô∏è  WARNING: Subject line is $SUBJECT_LENGTH chars (recommended: <72)" >&2
    echo "Consider shortening: $SUBJECT_LINE" >&2
    echo "" >&2
  fi

  echo "‚úì Commit message validated (main branch)"

else
  # SOFT ENFORCEMENT on feature branches
  echo "‚Üí Validating commit message (feature branch '$BRANCH' - soft enforcement)" >&2

  if [ "$LINE_COUNT" -gt 5 ]; then
    echo "" >&2
    echo "‚ö†Ô∏è  WARNING: Verbose commit message ($LINE_COUNT lines)" >&2
    echo "" >&2
    echo "Current message:" >&2
    echo "$MESSAGE" | head -3 >&2
    [ "$LINE_COUNT" -gt 3 ] && echo "..." >&2
    echo "" >&2
    echo "üí° Suggested format (conventional commits):" >&2
    echo "  <type>(<scope>): <what changed in 5-10 words>" >&2
    echo "" >&2
    echo "  Examples:" >&2
    echo "    feat(nav): add filter support for annotations" >&2
    echo "    fix(modal): correct title update on navigation" >&2
    echo "    docs: update testing guide with contract examples" >&2
    echo "" >&2
    if [ "$NEEDS_FORMAT_FIX" = true ]; then
      echo "‚ö†Ô∏è  Message doesn't follow conventional commits format" >&2
      echo "" >&2
    fi
    echo "Proceeding anyway (feature branch)..." >&2
    echo "Remember to squash before merging to main!" >&2
    echo "" >&2
  fi

  if [ "$SUBJECT_LENGTH" -gt 72 ]; then
    echo "‚ö†Ô∏è  INFO: Subject line is $SUBJECT_LENGTH chars (recommended: <72)" >&2
  fi

  echo "‚úì Commit message accepted (feature branch)"
fi
